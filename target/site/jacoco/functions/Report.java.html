<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Report.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">functions-hello-world</a> &gt; <a href="index.source.html" class="el_package">functions</a> &gt; <span class="el_source">Report.java</span></div><h1>Report.java</h1><pre class="source lang-java linenums">package functions;

import com.google.cloud.functions.HttpFunction;
import com.google.cloud.functions.HttpRequest;
import com.google.cloud.functions.HttpResponse;
import com.google.gson.Gson;
import com.google.gson.JsonArray;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import java.io.BufferedWriter;
import java.io.IOException;
import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest.BodyPublishers;
import java.net.http.HttpResponse.BodyHandlers;
import java.time.Instant;
import java.time.format.DateTimeFormatter;
public class Report implements HttpFunction {
  private static final String MS_FEEDBACK_BASE_URL_ENV = &quot;MS_FEEDBACK_BASE_URL&quot;;
  private static final String NOTIFICATION_BASE_URL_ENV = &quot;NOTIFICATION_BASE_URL&quot;;
  private static final String REPORT_EMAIL_ENV = &quot;REPORT_EMAIL&quot;;
  
  private final HttpClient httpClient;
  private final Gson gson;

  public Report() {
<span class="nc" id="L27">    this(HttpClient.newHttpClient());</span>
<span class="nc" id="L28">  }</span>

<span class="fc" id="L30">  Report(HttpClient httpClient) {</span>
<span class="fc" id="L31">    this.httpClient = httpClient;</span>
<span class="fc" id="L32">    this.gson = new Gson();</span>
<span class="fc" id="L33">  }</span>

  @Override
  public void service(HttpRequest request, HttpResponse response)
      throws IOException {
<span class="fc" id="L38">    BufferedWriter writer = response.getWriter();</span>
    
    try {
<span class="fc" id="L41">      String msFeedbackBaseUrl = getEnvVar(MS_FEEDBACK_BASE_URL_ENV);</span>
<span class="fc" id="L42">      String notificationBaseUrl = getEnvVar(NOTIFICATION_BASE_URL_ENV);</span>
<span class="fc" id="L43">      String reportEmail = getEnvVar(REPORT_EMAIL_ENV);</span>
      
<span class="fc bfc" id="L45" title="All 4 branches covered.">      if (msFeedbackBaseUrl == null || msFeedbackBaseUrl.isEmpty()) {</span>
<span class="fc" id="L46">        response.setStatusCode(500);</span>
<span class="fc" id="L47">        writer.write(&quot;{\&quot;error\&quot;: \&quot;MS_FEEDBACK_BASE_URL environment variable is not set\&quot;}&quot;);</span>
<span class="fc" id="L48">        return;</span>
      }
      
<span class="pc bpc" id="L51" title="1 of 4 branches missed.">      if (notificationBaseUrl == null || notificationBaseUrl.isEmpty()) {</span>
<span class="fc" id="L52">        response.setStatusCode(500);</span>
<span class="fc" id="L53">        writer.write(&quot;{\&quot;error\&quot;: \&quot;NOTIFICATION_BASE_URL environment variable is not set\&quot;}&quot;);</span>
<span class="fc" id="L54">        return;</span>
      }
      
<span class="pc bpc" id="L57" title="1 of 4 branches missed.">      if (reportEmail == null || reportEmail.isEmpty()) {</span>
<span class="fc" id="L58">        response.setStatusCode(500);</span>
<span class="fc" id="L59">        writer.write(&quot;{\&quot;error\&quot;: \&quot;REPORT_EMAIL environment variable is not set\&quot;}&quot;);</span>
<span class="fc" id="L60">        return;</span>
      }

<span class="fc" id="L63">      String currentDate = Instant.now().atZone(java.time.ZoneId.of(&quot;UTC&quot;))</span>
<span class="fc" id="L64">          .format(DateTimeFormatter.ISO_INSTANT);</span>

<span class="fc" id="L66">      String feedbackUrl = msFeedbackBaseUrl + &quot;/ms-feedback/v1/feedback/report&quot;;</span>
<span class="fc" id="L67">      JsonObject requestBody = new JsonObject();</span>
<span class="fc" id="L68">      requestBody.addProperty(&quot;date&quot;, currentDate);</span>
      
<span class="fc" id="L70">      java.net.http.HttpRequest feedbackRequest = java.net.http.HttpRequest.newBuilder()</span>
<span class="fc" id="L71">          .uri(URI.create(feedbackUrl))</span>
<span class="fc" id="L72">          .header(&quot;accept&quot;, &quot;application/json&quot;)</span>
<span class="fc" id="L73">          .header(&quot;Content-Type&quot;, &quot;application/json&quot;)</span>
<span class="fc" id="L74">          .POST(BodyPublishers.ofString(gson.toJson(requestBody)))</span>
<span class="fc" id="L75">          .build();</span>

<span class="fc" id="L77">      java.net.http.HttpResponse&lt;String&gt; feedbackResponse = httpClient.send(</span>
<span class="fc" id="L78">          feedbackRequest, BodyHandlers.ofString());</span>

<span class="fc bfc" id="L80" title="All 2 branches covered.">      if (feedbackResponse.statusCode() != 200) {</span>
<span class="fc" id="L81">        response.setStatusCode(feedbackResponse.statusCode());</span>
<span class="fc" id="L82">        writer.write(&quot;{\&quot;error\&quot;: \&quot;Failed to fetch feedback report: &quot; + </span>
<span class="fc" id="L83">            feedbackResponse.statusCode() + &quot;\&quot;}&quot;);</span>
<span class="fc" id="L84">        return;</span>
      }

<span class="fc" id="L87">      JsonObject feedbackData = JsonParser.parseString(feedbackResponse.body()).getAsJsonObject();</span>
<span class="fc" id="L88">      String formattedReport = formatReport(feedbackData);</span>

<span class="fc" id="L90">      JsonObject notificationBody = new JsonObject();</span>
<span class="fc" id="L91">      notificationBody.addProperty(&quot;to&quot;, reportEmail);</span>
<span class="fc" id="L92">      notificationBody.addProperty(&quot;subject&quot;, &quot;Feedback Report&quot;);</span>
<span class="fc" id="L93">      notificationBody.addProperty(&quot;body&quot;, formattedReport);</span>

<span class="fc" id="L95">      java.net.http.HttpRequest notificationRequest = java.net.http.HttpRequest.newBuilder()</span>
<span class="fc" id="L96">          .uri(URI.create(notificationBaseUrl))</span>
<span class="fc" id="L97">          .header(&quot;Content-Type&quot;, &quot;application/json&quot;)</span>
<span class="fc" id="L98">          .POST(BodyPublishers.ofString(gson.toJson(notificationBody)))</span>
<span class="fc" id="L99">          .build();</span>

<span class="fc" id="L101">      java.net.http.HttpResponse&lt;String&gt; notificationResponse = httpClient.send(</span>
<span class="fc" id="L102">          notificationRequest, BodyHandlers.ofString());</span>

<span class="pc bpc" id="L104" title="1 of 4 branches missed.">      if (notificationResponse.statusCode() &lt; 200 || notificationResponse.statusCode() &gt;= 300) {</span>
<span class="fc" id="L105">        response.setStatusCode(notificationResponse.statusCode());</span>
<span class="fc" id="L106">        writer.write(&quot;{\&quot;error\&quot;: \&quot;Failed to send notification: &quot; + </span>
<span class="fc" id="L107">            notificationResponse.statusCode() + &quot;\&quot;}&quot;);</span>
<span class="fc" id="L108">        return;</span>
      }

<span class="fc" id="L111">      response.setStatusCode(200);</span>
<span class="fc" id="L112">      response.setContentType(&quot;application/json&quot;);</span>
<span class="fc" id="L113">      writer.write(&quot;{\&quot;message\&quot;: \&quot;Report generated and sent successfully\&quot;}&quot;);</span>

<span class="fc" id="L115">    } catch (Exception e) {</span>
<span class="fc" id="L116">      response.setStatusCode(500);</span>
<span class="fc" id="L117">      writer.write(&quot;{\&quot;error\&quot;: \&quot;&quot; + e.getMessage() + &quot;\&quot;}&quot;);</span>
<span class="fc" id="L118">    }</span>
<span class="fc" id="L119">  }</span>

  String formatReport(JsonObject feedbackData) {
<span class="fc" id="L122">    StringBuilder report = new StringBuilder();</span>
<span class="fc" id="L123">    report.append(&quot;Feedback Report\n&quot;);</span>
<span class="fc" id="L124">    report.append(&quot;===============\n\n&quot;);</span>

<span class="fc bfc" id="L126" title="All 2 branches covered.">    if (feedbackData.has(&quot;evaluationsPerDay&quot;)) {</span>
<span class="fc" id="L127">      JsonArray evaluationsPerDay = feedbackData.getAsJsonArray(&quot;evaluationsPerDay&quot;);</span>
<span class="fc" id="L128">      report.append(&quot;Evaluations per day:\n&quot;);</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">      for (int i = 0; i &lt; evaluationsPerDay.size(); i++) {</span>
<span class="fc" id="L130">        JsonObject dayData = evaluationsPerDay.get(i).getAsJsonObject();</span>
<span class="fc" id="L131">        String day = dayData.get(&quot;day&quot;).getAsString();</span>
<span class="fc" id="L132">        int quantity = dayData.get(&quot;quantity&quot;).getAsInt();</span>
<span class="fc" id="L133">        report.append(&quot;  &quot;).append(day).append(&quot;: &quot;).append(quantity).append(&quot;\n&quot;);</span>
      }
<span class="fc" id="L135">      report.append(&quot;\n&quot;);</span>
    }

<span class="fc bfc" id="L138" title="All 2 branches covered.">    if (feedbackData.has(&quot;evaluationsPerUrgency&quot;)) {</span>
<span class="fc" id="L139">      JsonArray evaluationsPerUrgency = feedbackData.getAsJsonArray(&quot;evaluationsPerUrgency&quot;);</span>
<span class="fc" id="L140">      report.append(&quot;Evaluations per urgency:\n&quot;);</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">      for (int i = 0; i &lt; evaluationsPerUrgency.size(); i++) {</span>
<span class="fc" id="L142">        JsonObject urgencyData = evaluationsPerUrgency.get(i).getAsJsonObject();</span>
<span class="fc" id="L143">        String urgency = urgencyData.get(&quot;urgency&quot;).getAsString();</span>
<span class="fc" id="L144">        int quantity = urgencyData.get(&quot;quantity&quot;).getAsInt();</span>
<span class="fc" id="L145">        report.append(&quot;  &quot;).append(urgency).append(&quot;: &quot;).append(quantity).append(&quot;\n&quot;);</span>
      }
    }

<span class="fc" id="L149">    return report.toString();</span>
  }

  String getEnvVar(String name) {
<span class="fc" id="L153">    return System.getenv(name);</span>
  }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>